/*
 PolarMap.js 0.6.0 (c12467a)
 (c) 2014 Arctic Connect, Geo Sensor Web Lab
*/
!function(t,e,o,i){if("undefined"==typeof o)var o={};o.PolarMap={version:"0.6.0",Control:{},Util:{}},"object"==typeof module&&"object"==typeof module.exports?module.exports=o.PolarMap:"function"==typeof define&&define.amd&&define(o.PolarMap),o.PolarMap.Control.Rotation=o.Control.extend({options:{position:"topright",cwText:"&orarr;",cwTitle:"Rotate Clockwise",ccwText:"&olarr;",ccwTitle:"Rotate Counter-Clockwise"},onAdd:function(){var t="leaflet-control-rotation",e=o.DomUtil.create("div",t+" leaflet-bar"),i=this.options;return this._cwButton=this._createButton(i.cwText,i.cwTitle,t+"-cw",e,this._rotateCW),this._ccwButton=this._createButton(i.ccwText,i.ccwTitle,t+"-ccw",e,this._rotateCCW),e},_rotateCW:function(){this.options.onRotateCW&&this.options.onRotateCW()},_rotateCCW:function(){this.options.onRotateCCW&&this.options.onRotateCCW()},_createButton:function(t,e,i,n,a){var s=o.DomUtil.create("a",i,n);return s.innerHTML=t,s.href="#",s.title=e,o.DomEvent.on(s,"mousedown dblclick",o.DomEvent.stopPropagation).on(s,"click",o.DomEvent.stop).on(s,"click",a,this).on(s,"click",this._refocusOnMap,this),s}}),o.PolarMap.Control.rotation=function(t){return new o.PolarMap.Control.Rotation(t)},o.PolarMap.TileLayer=o.TileLayer.extend({}),o.PolarMap.tileLayer=function(t,e){return new o.PolarMap.TileLayer(t,e)},o.PolarMap.Util.Hash=o.Class.extend({options:{map:null,lastHash:null,movingMap:!1,changeDefer:100,changeTimeout:null,isListening:!1,hashChangeInterval:null,getBaseLayer:null,setBaseLayer:null},initialize:function(e,n){n=o.setOptions(this,n),this.HAS_HASHCHANGE=function(){var e=t.documentMode;return"onhashchange"in t&&(e===i||e>7)}(),this.onHashChange=o.Util.bind(this.onHashChange,this),this.map=e,this.options.lastHash=null,this.onHashChange(),this.options.isListening||this.startListening()},formatHash:function(t){var e=[],o=t.getCenter(),i=t.getZoom(),n=Math.max(0,Math.ceil(Math.log(i)/Math.LN2));return null!==this.options.getBaseLayer&&e.push(this.options.getBaseLayer()),e.push(i,o.lat.toFixed(n),o.lng.toFixed(n)),"#"+e.join("/")},onHashChange:function(){if(!this.options.changeTimeout){var t=this;this.options.changeTimeout=setTimeout(function(){t.update(),t.options.changeTimeout=null},this.options.changeDefer)}},onMapMove:function(){if(this.options.movingMap||!this.map._loaded)return!1;var t=this.formatHash(this.map);this.options.lastHash!=t&&(location.replace(t),this.options.lastHash=t)},parseHash:function(t){0===t.indexOf("#")&&(t=t.substr(1));var e=t.split("/");if(4===e.length){var i=e[0],n=parseInt(e[1],10),a=parseFloat(e[2]),s=parseFloat(e[3]);return""===i||isNaN(n)||isNaN(a)||isNaN(s)?!1:{baseLayer:i,center:new o.LatLng(a,s),zoom:n}}if(3===e.length){var n=parseInt(e[0],10),a=parseFloat(e[1]),s=parseFloat(e[2]);return isNaN(n)||isNaN(a)||isNaN(s)?!1:{center:new o.LatLng(a,s),zoom:n}}return!1},removeFrom:function(){this.options.changeTimeout&&clearTimeout(this.options.changeTimeout),this.options.isListening&&this.stopListening(),this.map=null},startListening:function(){this.map.on("moveend",this.onMapMove,this),this.HAS_HASHCHANGE?o.DomEvent.addListener(t,"hashchange",this.onHashChange):(clearInterval(this.options.hashChangeInterval),this.options.hashChangeInterval=setInterval(this.onHashChange,50)),this.options.isListening=!0},stopListening:function(){this.map.off("moveend",this.onMapMove,this),this.HAS_HASHCHANGE?o.DomEvent.removeListener(t,"hashchange",this.onHashChange):clearInterval(this.options.hashChangeInterval),this.options.isListening=!1},update:function(){var t=location.hash;if(t!==this.options.lastHash){var e=this.parseHash(t);e?(this.options.movingMap=!0,e.baseLayer!==i&&this.options.setBaseLayer(e.baseLayer),this.map.setView(e.center,e.zoom),this.options.movingMap=!1):this.onMapMove(this.map)}}}),o.PolarMap.Util.hash=function(t,e){return new o.PolarMap.Util.Hash(t,e)},o.PolarMap.Map=o.Map.extend({options:{changingMap:!1,fadeAnimation:!0,trackResize:!0,markerZoomAnimation:!0,center:o.latLng([90,0]),zoom:1},initialize:function(t,e){e=o.setOptions(this,e);e.baseLayer.options;this._initContainer(t),this._initLayout(),this._onResize=o.bind(this._onResize,this),this._initEvents(),e.maxBounds&&this.setMaxBounds(e.maxBounds),e.center&&e.zoom!==i&&this.setView(o.latLng(e.center),e.zoom,{reset:!0}),this._handlers=[],this._layers={},this._zoomBoundLayers={},this.callInitHooks(),this.on("baselayerchange",function(t){t.layer.options;this._update(t.layer)}),this._update(e.baseLayer)},loadTileProjection:function(t){if(this.options.changingMap)return!1;if(this._usingTileProjection(t))console.log("That tile layer is already active.");else{{t.options}this._dropTileLayers(),this._update(t)}},_defineMapCRS:function(t,e){for(var i=[],n=e.minZoom;n<=e.maxZoom;n++)i.push(e.maxResolution/Math.pow(2,n));return new o.Proj.CRS(t,e.proj4def,{origin:e.origin,resolutions:i,bounds:e.projectedBounds})},_dropTileLayers:function(){var t=this;t.eachLayer(function(e){e instanceof o.TileLayer&&t.removeLayer(e)})},_setMapCRS:function(t,e){switch(t){case"EPSG:3857":return o.CRS.EPSG3857;case"EPSG:3395":return o.CRS.EPSG3395;case"EPSG:4326":return o.CRS.EPSG4326;default:return this._defineMapCRS(t,e)}},_update:function(t){if(this.options.changingMap)return!1;this.options.changingMap=!0;var e=this.getCenter(),o=this.getZoom();this._updateCRSAndLayers(t.options),this.addLayer(t,!0),this.setView(e,o,{reset:!0}),this.setMaxBounds(t.options.bounds),this.options.changingMap=!1},_updateAllLayers:function(t){var e=this;t.eachLayer?t.eachLayer(function(t){e._updateAllLayers(t)}):t.redraw?t.redraw():t.update?t.update():console.log("Don't know how to update",t)},_updateCRSAndLayers:function(t){this.options.crs=this._setMapCRS(t.crs,t),this._updateAllLayers(this)},_usingTileProjection:function(t){var e=!1,o=this._layers;for(var i in o)if(e=o[i]===t)break;return e}}),o.PolarMap.map=function(t,e){return new o.PolarMap.Map(t,e)};var n={tileHeader:"Arctic Connect: ",attribution:'Map &copy; <a href="http://arcticconnect.org">ArcticConnect</a>. Data &copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',locationDetectionError:"Location detection error: "};proj4.defs([["EPSG:3571","+proj=laea +lat_0=90 +lon_0=180 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"],["EPSG:3572","+proj=laea +lat_0=90 +lon_0=-150 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"],["EPSG:3573","+proj=laea +lat_0=90 +lon_0=-100 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"],["EPSG:3574","+proj=laea +lat_0=90 +lon_0=-40 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"],["EPSG:3575","+proj=laea +lat_0=90 +lon_0=10 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"],["EPSG:3576","+proj=laea +lat_0=90 +lon_0=90 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"]]);for(var a=["EPSG:3571","EPSG:3572","EPSG:3573","EPSG:3574","EPSG:3575","EPSG:3576"],s={},r=20037509.762000002,h=0;h<a.length;h++){var l=a[h],p=3571+h,c="http://{s}.tiles.arcticconnect.org/osm_"+p+"/{z}/{x}/{y}.png";s[n.tileHeader+l]=o.PolarMap.tileLayer(c,{name:"ac_"+p,crs:l,minZoom:0,maxZoom:18,tms:!1,origin:[-r,r],maxResolution:(r- -r)/256,projectedBounds:o.bounds(o.point(-r,r),o.point(r,-r)),continuousWorld:!1,noWrap:!0,attribution:n.attribution})}for(var h=0;6>h;h++){var u=0===h?5:h-1,d=5===h?0:h+1,m=s[n.tileHeader+"EPSG:"+(3571+h)];m.prev=s[n.tileHeader+"EPSG:"+(3571+u)],m.next=s[n.tileHeader+"EPSG:"+(3571+d)]}t.PolarMap=o.Class.extend({options:{geosearch:!1,locate:!1,permalink:!0},statics:{VERSION:o.PolarMap.version},initialize:function(t,e){var i=this;o.Util.setOptions(this,e),this.tiles=s,this.layersControl=o.control.layers(this.tiles,null,{collapsed:!1}),this.rotationControls=o.PolarMap.Control.rotation({onRotateCW:function(){i.map.loadTileProjection(i.getBaseLayer().next)},onRotateCCW:function(){i.map.loadTileProjection(i.getBaseLayer().prev)}}),this.map=o.PolarMap.map(t,{baseLayer:this.tiles[n.tileHeader+"EPSG:3573"],center:[90,0],zoom:4}),this.layersControl.addTo(this.map),this.rotationControls.addTo(this.map),this.options.geosearch&&this._initGeosearch(),this.options.locate&&this._initLocate(),this.options.permalink&&this._initPermalink()},addLayer:function(t,e){this.map.addLayer(t),"undefined"!=typeof e&&e.switcher&&this.layersControl.addOverlay(t,e.name)},getBaseLayer:function(){var t=null;for(var e in this.tiles)this.tiles.hasOwnProperty(e)&&this.map.hasLayer(this.tiles[e])&&(t=this.tiles[e]);return t},_initGeosearch:function(){new o.Control.GeoSearch({provider:new o.GeoSearch.Provider.OpenStreetMap,showMarker:!1}).addTo(this.map)},_initLocate:function(){var t=this,e=o.circle();this.map.on("locationfound",function(o){e.setLatLng(o.latlng),e.setRadius(o.accuracy),t.map.hasLayer(e)||e.addTo(t.map),t._setProjectionForLongitude(o.longitude)}),this.map.on("locationerror",function(t){console.warn(n.locationDetectionError,t)}),this.map.locate()},_initPermalink:function(){var t=this;this.hash=o.PolarMap.Util.hash(this.map,{getBaseLayer:function(){return t.getBaseLayer().options.name},setBaseLayer:function(e){t._setBaseLayer(e)}})},_setBaseLayer:function(t){var e=this;for(var o in this.tiles)this.tiles.hasOwnProperty(o)&&this.tiles[o].options.name===t&&e.map.loadTileProjection(this.tiles[o])},_setProjectionForLongitude:function(t){var e;e=t>=-180&&-165>=t?"EPSG:3571":t>-165&&-125>=t?"EPSG:3572":t>-125&&-70>=t?"EPSG:3573":t>-70&&-15>=t?"EPSG:3574":t>-15&&50>=t?"EPSG:3575":t>50&&135>=t?"EPSG:3576":"EPSG:3571",this.map.loadTileProjection(this.tiles[n.tileHeader+e])}}),t.polarMap=function(t,e){return new PolarMap(t,e)}}(window,document,L);